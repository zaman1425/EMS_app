pipeline{
agent any
environment{
    DOCKERHUB_USERNAME="zaman1425"
    IMAGE_NAME="${zaman1425}/ems_app"
    DOCKERHUB_CREDENTIALS= credentials('docker-hub-cred')
    KUBECONFIG_CREDENTIALS= credentials('minikube-kubeconfig')
}
stages{
    stage('checkout code'){
        steps{
            git branch: 'main', url: 'https://github.com/zaman1425/ems_app.git'
        }
    }
    stage('build docker image'){
        steps{
            script{
                sh 'minikube docker-env'
                sh "docker-built -t ${ems_app}:${BUILD_NAME} ."
            }
        }
    }

    stage('push docker image to docker hub'){
        steps{
            withcredentials([usernamepassword(credentialsID: "${docker-hub-cred}", usernameVariable: 'DOCKERHUB_USER', passwordVraiable: 'DOCKERHUB_PASS')]){
                sh "echo ${DOCKERHUB_PASS} | docker login -u ${DOCKERHUB_USER} --password-stdin"
                sh "docker push ${ems_app}:${BUILD_NAME}"
            }
        }
    }

    stage('deploy to minikube'){
        steps{
            withcredentials([file(credentialsID: "${minikube-kubeconfig}", variable: 'KUBECONFIG_FILE')]){
                sh 'kubectl config use-context minikube'
                sh 'kubectl apply -f deployment.yaml'
                sh 'kubectl apply -f service.yaml'
            }
        }
    }

}
}